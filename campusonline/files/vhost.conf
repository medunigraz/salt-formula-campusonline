<VirtualHost *:80>
  ServerAdmin {{ site.admin }}
  ServerName {{ site.hostname }}

  LogLevel warn
  ErrorLog "/var/log/apache2/error.{{ site.hostname }}.log"

  RewriteEngine on
  RewriteRule ^/(.*)$ https://%{SERVER_NAME}/$1 [R=301,L]
</VirtualHost>
<VirtualHost *:443>
  ServerAdmin {{ site.admin }}
  ServerName {{ site.hostname }}

  LogLevel warn
  DeflateFilterNote ratio
  LogFormat "%h %l %u %t \"%r\" %>s %b (%{ratio}n%%)\"%{Referer}i\" \"%{User-Agent}i\"" campusonline
  CustomLog "/var/log/apache2/access.{{ site.hostname }}.log" campusonline
  ErrorLog "/var/log/apache2/error.{{ site.hostname }}.log"

  TimeOut 155
  KeepAlive On
  MaxKeepAliveRequests 500
  KeepAliveTimeOut 10
  UseCanonicalName On

  <Files ".ht*">
      Require all denied
  </Files>

  RequestHeader unset Proxy early

  AddType application/x-compress .Z
  AddType application/x-gzip .gz .tgz
  AddType application/javascript .js

  <Location /status>
    SetHandler server-status
    Require ip {% for allow in site.proxy.status %}{{ allow }}{% if not loop.last %} {% endif %}{% endfor %}
  </Location>

  ProxyRequests Off
  RewriteEngine on
  Options +FollowSymLinks

  RewriteRule ^/$ /{{ site.proxy.path }}/ee/ui/ca2/app/desktop/#/login?$ctx=lang= [R=301,NE,L]

  ProxyPass /status !

  <Location />
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
    Header append Vary User-Agent
  </Location>

  SetEnvIf Request_URI ^/{{ site.proxy.path }}/pl/ui/(\$ctx.*?)/(.*)$ CTX_INFO=$1

  <LocationMatch /{{ site.proxy.path }}/pl/ui/>
    RequestHeader append Referer %{CTX_INFO}e
  </LocationMatch>

  ProxyPassMatch "^/{{ site.proxy.path }}/pl/ui/(\$ctx.*?)/(.*)$" "{{ site.proxy.services.ohs }}/{{ site.proxy.path }}/$2"
  <LocationMatch /{{ site.proxy.path }}/pl/rest/>
    SetEnvIfNoCase X-HTTP-Method-Override ^(put|options|delete)$ HAVE_METHOD_OVERRIDE=$1
    RequestHeader append Referer $method=%{HAVE_METHOD_OVERRIDE}e env=HAVE_METHOD_OVERRIDE
  </LocationMatch>

  ProxyPass        /{{ site.proxy.path }}/pl/rest/ {{ site.proxy.services.ohs }}/{{ site.proxy.path }}/!rest/
  ProxyPassReverse /{{ site.proxy.path }}/pl/rest/ {{ site.proxy.services.ohs }}/{{ site.proxy.path }}/!rest/

  ProxyPass        /{{ site.proxy.path }}/ee/ui/ca2/ {{ site.proxy.services.co_ee }}/co_ee_client_ca2/
  ProxyPassReverse /{{ site.proxy.path }}/ee/ui/ca2/ {{ site.proxy.services.co_ee }}/co_ee_client_ca2/

  ProxyPass        /{{ site.proxy.path }}/ee/theme/ca2/ {{ site.proxy.services.ohs }}/bmug/theme/
  ProxyPassReverse /{{ site.proxy.path }}/ee/theme/ca2/ {{ site.proxy.services.ohs }}/bmug/theme/

  ProxyPass        /{{ site.proxy.path }}/ee/ {{ site.proxy.services.co_ee }}/co_ee_ws/
  ProxyPassReverse /{{ site.proxy.path }}/ee/ {{ site.proxy.services.co_ee }}/co_ee_ws/

  ProxyPass        /{{ site.proxy.path }}/pl/img {{ site.proxy.services.ohs }}/bmug/img
  ProxyPassReverse /{{ site.proxy.path }}/pl/img {{ site.proxy.services.ohs }}/bmug/img

  <Location "/fop/co_dp/">
    Require ip {% for host in site.database.hosts %}{{ host }}{% if not loop.last %} {% endif %}{% endfor %}
  </Location>
  ProxyPass "/fop/co_dp/" "{{ site.proxy.services.co_dp }}"
  ProxyPassReverse "/fop/co_dp/" "{{ site.proxy.services.co_dp }}"

  <Location "/reports">
    Require ip {% for host in site.database.hosts %}{{ host }}{% if not loop.last %} {% endif %}{% endfor %}
  </Location>
  ProxyPass "/reports" "{{ site.proxy.services.reports }}/reports"
  ProxyPassReverse "/reports" "{{ site.proxy.services.reports }}/reports"

  ProxyPass "/{{ site.proxy.path }}j/ws/" "{{ site.proxy.services.co_ws }}/ws/"
  ProxyPassReverse "/{{ site.proxy.path }}j/ws/" "{{ site.proxy.services.co_ws }}/ws/"

  ProxyPass "/" {{ site.proxy.services.ohs }}/" timeout=600 Keepalive=On
  ProxyPassReverse "/" ""{{ site.proxy.services.ohs }}/"

  <FilesMatch "\.(gif|png|css|js|jpe?g)$">
    ExpiresActive on
    ExpiresDefault "access plus 7 days"
  </FilesMatch>

  Header edit Set-Cookie ^(.*)$ $1;Secure;HttpOnly

  SSLEngine on

  SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
  SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH

  SSLCertificateFile "{{ proxy.tls.public }}/{{ site.hostname }}.pem"
  SSLCertificateKeyFile "{{ proxy.tls.private }}/{{ site.hostname }}.pem"
  SSLCertificateChainFile "{{ proxy.tls.public }}/{{ site.hostname }}.chain.pem"

  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains;"
  Header always set X-Frame-Options "sameorigin"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set X-Content-Type-Options "nosniff"

</VirtualHost>
